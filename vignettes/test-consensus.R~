library(devtools)

## Imports
gset.rankcor <- playbase::gset.rankcor
mat2gmt <- playbase::mat2gmt
##mofa.merge_data2 <- playbase::mofa.merge_data2
ai.ask <- playbase::ai.ask
ai.create_image_gemini <- playbase::ai.create_image_gemini

##------------------------------------------------------------
## Run Consensus WGCNA
##------------------------------------------------------------
load_all()

pgx <- playbase::pgx.load("~/Playground/omicsplayground/data/multi-liver.pgx")
pgx <- playbase::pgx.initialize(pgx)

group <- pgx$samples$sex
xx <- tapply(1:ncol(pgx$X), group, function(ii) pgx$X[,ii])
names(xx)

par(mfrow=c(2,3), mar=c(5,5,3,1), cex=1.4)
plotPowerAnalysis( t(xx[[1]]), setPar=FALSE)
plotPowerAnalysis( t(xx[[2]]), setPar=FALSE)

## This runs consensus WGCNA on an expression list
names(xx)
Y <- pgx$samples[,3:6]
##Y <- expandPhenoMatrix(Y)
head(Y)

cons <- runConsensusWGCNA(
  xx,
  phenoData = Y,
  power = 6,
  #GMT = pgx$GMT,
  annot = pgx$genes,
  compute.enrichment = 1,
  ngenes = 2000,
  minModuleSize = 40,
  maxBlockSize = 9999,
  minKME = 0.3,
  mergeCutHeight = 0.15,
  deepSplit = 2,
  calcMethod = "fast",
  drop.ref = FALSE,
  addCombined = FALSE,
  gsea.mingenes = 10,
  summary = TRUE,
  verbose = 1
) 

names(cons)
cons$net$power

x11()
par(cex=1.4)
plotDendroAndColors(
  cons, marAll=c(2,10,3,1), show.traits=1, show.kme=0, use.tree=0,
  colorHeight = 0.2, colorHeightMax = 0.7, setLayout=1
)  

head(cons$datTraits)
plotModuleScores(cons, trait="ab_fat", nmax = 9)
plotModuleScores(cons$layers[[1]], trait="ab_fat", nmax = 9)

##--------------------------------------------------------------------
## gene statistics
##--------------------------------------------------------------------
load_all()

top <- getTopGenesAndSets(cons, module=NULL, ntop=10) 
names(top)
lapply(top$genes,head)
lapply(top$sets,head)

stats <- computeConsensusGeneStats(cons)
names(stats)

head(stats[[1]][[1]])
module = "MEblue"
trait = "sex=Male"
trait = "ab_fat"

stats2 <- getConsensusGeneStats(cons, stats=stats, trait=trait, module=module)
names(stats2)
head(stats2[['full']])
head(stats2[['consensus']])

##--------------------------------------
## enrichment
##--------------------------------------

GMT = Matrix::t(playdata::GSETxGENE)
annot = pgx$genes
cons$gsea <- computeConsensusModuleEnrichment(
  cons, GMT=GMT, annot=annot,
  methods = c("fisher","gsetcor","xcor"),
  #methods = c("xcor"),
  min.genes=5, ntop=1000
)

names(cons$gsea)
top.gs <- head(cons$gsea[['MEblue']]$geneset,100) 
head(top.gs,20)

ai_model = "qwen3:1.7b"
ai_model = "groq:openai/gpt-oss-20b"
playbase::ai.genesets_summary(top.gs, model=ai_model)
playbase::ai.genesets_keywords(top.gs, model=ai_model) 

##------------------------------------------------------------
## Feature correlation analysis
##------------------------------------------------------------

names(cons$layers)
F <- list()
for(i in names(cons$layers)) {
  r1 <- cor( cons$layers[[i]]$datExpr, cons$layers[[i]]$datTraits, use="pairwise")
  F[[i]] <- r1
}
colx <- cons$net$colors

setname <- names(cons$layers)
par(mfrow=c(2,3), mar=c(5,5,3,1), cex=1.4)
for(i in 1:ncol(F[[1]])) {
  tt <- colnames(F[[1]])[i]
  f1 <- sapply(F, function(x) x[,i])
  plot( f1[,1], f1[,2], col=colx, main=tt,
    xlab = paste0("trait correlation (",setname[1],")"),
    ylab = paste0("trait correlation (",setname[2],")")
  )
  abline(v=0, h=0, lty=2, lwd=0.6)
}

head(pgx$genes)


##------------------------------------------------------------
## Sample clustering dendrograms
##------------------------------------------------------------
source("~/Playground/playbase/dev/include.R", chdir=TRUE)

lapply(exprList, dim)
dim(cons$modTraits)
head(cons$datTraits)[,1:4]

nsets <- length(exprList)
layout.matrix <- matrix( 1:(2*nsets), nrow = 2, ncol = nsets)
layout(layout.matrix, heights=c(1,1), widths=rep(1,nsets))
i=1
for(i in 1:nsets) {
  dt <- toupper(names(cons$datExpr)[i])
  wgcna.plotConsensusSampleDendroAndColors(
    cons, i,
    main = paste("sample tree and traits heatmap for", dt),
    what = c("me", "traits", "both")[2],
    marAll = c(0.2, 8, 1, 0.2),
    clust.expr = TRUE,
    setLayout = FALSE,
    colorHeightMax = 0.6
  ) 
}

##------------------------------------------------------------
## Module-trait heatmaps (important plots)
##------------------------------------------------------------
source("~/Playground/playbase/dev/include.R", chdir=TRUE)

lapply(cons$zlist, dim)
ii <- hclust(dist(cons$zlist[[1]]))$order
jj <- hclust(dist(t(cons$zlist[[1]])))$order

## fix ordering of heatmaps
Z <- Reduce('+', lapply(cons$zlist,dist))
tZ <- Reduce('+', lapply(lapply(cons$zlist,t),dist))
ii <- hclust(Z)$order
jj <- hclust(tZ)$order

par(mfrow=c(2,3), mar=c(12,12,5,1))
par(mfrow=c(2,3), mar=c(8,12,3,1))
for(i in 1:length(cons$zlist)) {
  k <- names(cons$zlist)[i]
  wgcna.plotLabeledCorrelationHeatmap(
    cons$zlist[[i]][ii,jj], cons$ydim[i], cex.lab = 1.2,
    pstar=1, text=FALSE, cluster=FALSE, setpar=FALSE,
    main = paste("module-trait for",toupper(k)))
}

## Consensus Module-Trait
matlist = cons$zlist
ydim <- sapply(cons$datExpr, nrow)
consZ <- wgcna.computeConsensusMatrix(cons$zlist, ydim=ydim, psig=0.05) 
nsamples <- ncol(exprList[[1]])
wgcna.plotLabeledCorrelationHeatmap(
  consZ[ii,jj], nsamples, setpar=FALSE,
  text=FALSE, pstar=1, cluster=FALSE, cex.lab=1.2,
  main = "consensus Module-Trait"
)

## Distinct Module-Trait
diffZ <- wgcna.computeDistinctMatrix(
  matlist, ydim=ydim, psig = 0.05, min.diff=0.1) 
names(diffZ)
for(set in names(diffZ)) {
  wgcna.plotLabeledCorrelationHeatmap(
    diffZ[[set]][ii,jj], nsamples, setpar=FALSE,
    text=FALSE, pstar=1, cluster=FALSE, cex.lab=1.2,
    main = paste("unique Module-Traits for",toupper(set))
  )
}

dim(consZ)
z0 <- consZ
z0[is.na(z0)] <- 0
z1 <- diffZ
for(i in 1:length(z1)) z1[[i]][is.na(z1[[i]])] <- 0
effZ <- abs(z0) - Reduce('+', lapply(z1,abs))
effZ
wgcna.plotLabeledCorrelationHeatmap(
  effZ[ii,jj], nsamples, setpar=FALSE,
  colorpal = purpleGreyYellow,
  text=FALSE, pstar=1, cluster=FALSE, cex.lab=1.2,
  main = "effective consensus"
)

cc <- rowMeans(effZ)
cc <- sort(cc, decreasing=TRUE)
barplot(cc, las=3, ylab="average consensus")


#----------------------------------------------------------------
#  Conservation/Preservation Summary plot (nice plot!)
#----------------------------------------------------------------
source("~/Playground/playbase/dev/include.R", chdir=TRUE)

MEs <- cons$net$multiMEs
lapply(MEs, function(m) dim(m$data))
modules <- colnames(MEs[[1]]$data)

par(mfrow=c(2,1), mar=c(12,4,2,2))
for(k in names(MEs)) {
  ME <- MEs[[k]]$data
  wgcna.plotEigenGeneClusterDendrogram(
    wgcna=NULL, ME=ME, main = k,
    setMargins=FALSE, method="hclust")
}

par(cex = 0.9)
WGCNA::plotEigengeneNetworks(
  MEs,
  setLabels = names(exprList),
  plotDendrograms = FALSE,
#  plotHeatmaps = FALSE,
  marDendro = c(0,2,2,1)*1.5,
  marHeatmap = c(3,3,2,1)*1.5,
  zlimPreservation = c(0.5, 1),
  xLabelsAngle = 90
)



hc <- hclust(as.dist(1 - cor(ME)), method="average")
plot(hc, horiz=TRUE)

wgcna.plotEigenGeneClusterDendrogram(wgcna=NULL, ME=ME)

x
#----------------------------------------------------------------
# Create cross-table for comparison (not so usefull...)
#----------------------------------------------------------------
source("~/Playground/playbase/dev/include.R", chdir=TRUE)

net0 <- cons$net
net1 <- cons$netList[[1]]$net
net2 <- cons$netList[[2]]$net 
names(cons$netList)
wgcna.plotConsensusOverlapHeatmap(
  net1, net2, setLabels=names(cons$netList))

